//var device_json = JSON.parse('');
var device_json = JSON.parse('{"name":"My Device","params":{"width":75800,"height":51000},"layers":[{"name":"flow","color":"indigo","params":{"z_offset":0,"flip":false},"features":{"63798de0-3d40-11e5-8695-8185f7405bd4":{"id":"63798de0-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[30000,40000],"radius1":700,"height":100}},"63798de1-3d40-11e5-8695-8185f7405bd4":{"id":"63798de1-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[40000,40000],"radius1":700,"height":100}},"63798de2-3d40-11e5-8695-8185f7405bd4":{"id":"63798de2-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[50000,40000],"radius1":700,"height":100}},"63798de3-3d40-11e5-8695-8185f7405bd4":{"id":"63798de3-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[20000,40000],"radius1":700,"height":100}},"63798de4-3d40-11e5-8695-8185f7405bd4":{"id":"63798de4-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[20000,40000],"end":[20000,35000],"width":400,"height":100}},"63798de5-3d40-11e5-8695-8185f7405bd4":{"id":"63798de5-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[20000,38000],"end":[17000,38000],"width":400,"height":100}},"63798de6-3d40-11e5-8695-8185f7405bd4":{"id":"63798de6-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[17000,38000],"end":[17000,35000],"width":400,"height":100}},"63798de7-3d40-11e5-8695-8185f7405bd4":{"id":"63798de7-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[20000,35000],"end":[20000,20000],"width":400,"height":100}},"63798de8-3d40-11e5-8695-8185f7405bd4":{"id":"63798de8-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[20000,20000],"end":[10000,10000],"width":400,"height":100}},"63798de9-3d40-11e5-8695-8185f7405bd4":{"id":"63798de9-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[17000,35000],"end":[15000,30000],"width":400,"height":100}},"63798dea-3d40-11e5-8695-8185f7405bd4":{"id":"63798dea-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[15000,30000],"end":[10000,30000],"width":400,"height":100}},"63798deb-3d40-11e5-8695-8185f7405bd4":{"id":"63798deb-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[10000,30000],"end":[10000,28000],"width":400,"height":100}},"6379b4f0-3d40-11e5-8695-8185f7405bd4":{"id":"6379b4f0-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[10000,28000],"end":[15000,28000],"width":400,"height":100}},"6379b4f1-3d40-11e5-8695-8185f7405bd4":{"id":"6379b4f1-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[15000,28000],"end":[15000,25000],"width":400,"height":100}},"6379b4f2-3d40-11e5-8695-8185f7405bd4":{"id":"6379b4f2-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[15000,25000],"end":[8000,25000],"width":400,"height":100}},"6379b4f3-3d40-11e5-8695-8185f7405bd4":{"id":"6379b4f3-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[8000,25000],"radius1":700,"height":100}},"6379b4f4-3d40-11e5-8695-8185f7405bd4":{"id":"6379b4f4-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[10000,10000],"radius1":700,"height":100}},"6379b4f5-3d40-11e5-8695-8185f7405bd4":{"id":"6379b4f5-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[30000,40000],"end":[30000,20000],"width":400,"height":100}},"6379b4f6-3d40-11e5-8695-8185f7405bd4":{"id":"6379b4f6-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[30000,20000],"end":[20000,10000],"width":400,"height":100}},"6379b4f7-3d40-11e5-8695-8185f7405bd4":{"id":"6379b4f7-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[20000,10000],"radius1":700,"height":100}},"6379b4f8-3d40-11e5-8695-8185f7405bd4":{"id":"6379b4f8-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[30000,38000],"end":[27000,38000],"width":400,"height":100}},"6379b4f9-3d40-11e5-8695-8185f7405bd4":{"id":"6379b4f9-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[27000,38000],"end":[27000,30000],"width":400,"height":100}},"6379b4fa-3d40-11e5-8695-8185f7405bd4":{"id":"6379b4fa-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[27000,30000],"end":[22000,30000],"width":400,"height":100}},"6379dc00-3d40-11e5-8695-8185f7405bd4":{"id":"6379dc00-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[22000,30000],"end":[22000,28000],"width":400,"height":100}},"6379dc01-3d40-11e5-8695-8185f7405bd4":{"id":"6379dc01-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[22000,28000],"end":[27000,28000],"width":400,"height":100}},"6379dc02-3d40-11e5-8695-8185f7405bd4":{"id":"6379dc02-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[27000,28000],"end":[27000,26000],"width":400,"height":100}},"6379dc03-3d40-11e5-8695-8185f7405bd4":{"id":"6379dc03-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[27000,26000],"end":[22000,26000],"width":400,"height":100}},"637a2a20-3d40-11e5-8695-8185f7405bd4":{"id":"637a2a20-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[22000,26000],"end":[22000,24000],"width":400,"height":100}},"637a2a21-3d40-11e5-8695-8185f7405bd4":{"id":"637a2a21-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[22000,24000],"end":[27000,24000],"width":400,"height":100}},"637a5130-3d40-11e5-8695-8185f7405bd4":{"id":"637a5130-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[27000,24000],"end":[27000,22000],"width":400,"height":100}},"637a5131-3d40-11e5-8695-8185f7405bd4":{"id":"637a5131-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[27000,22000],"end":[22000,22000],"width":400,"height":100}},"637a5132-3d40-11e5-8695-8185f7405bd4":{"id":"637a5132-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[22000,22000],"end":[22000,20000],"width":400,"height":100}},"637a5133-3d40-11e5-8695-8185f7405bd4":{"id":"637a5133-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[22000,20000],"end":[25000,20000],"width":400,"height":100}},"637a5134-3d40-11e5-8695-8185f7405bd4":{"id":"637a5134-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[25000,20000],"end":[25000,17000],"width":400,"height":100}},"637a5135-3d40-11e5-8695-8185f7405bd4":{"id":"637a5135-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[25000,17000],"end":[21000,17000],"width":400,"height":100}},"637a5136-3d40-11e5-8695-8185f7405bd4":{"id":"637a5136-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[21000,17000],"radius1":700,"height":100}},"637a5137-3d40-11e5-8695-8185f7405bd4":{"id":"637a5137-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[40000,40000],"end":[40000,20000],"width":400,"height":100}},"637a5138-3d40-11e5-8695-8185f7405bd4":{"id":"637a5138-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[40000,20000],"end":[50000,10000],"width":400,"height":100}},"637a5139-3d40-11e5-8695-8185f7405bd4":{"id":"637a5139-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[40000,38000],"end":[43000,38000],"width":400,"height":100}},"637a513a-3d40-11e5-8695-8185f7405bd4":{"id":"637a513a-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[43000,38000],"end":[43000,30000],"width":400,"height":100}},"637a513b-3d40-11e5-8695-8185f7405bd4":{"id":"637a513b-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[43000,30000],"end":[48000,30000],"width":400,"height":100}},"637a513c-3d40-11e5-8695-8185f7405bd4":{"id":"637a513c-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[48000,30000],"end":[48000,28000],"width":400,"height":100}},"637a513d-3d40-11e5-8695-8185f7405bd4":{"id":"637a513d-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[48000,28000],"end":[43000,28000],"width":400,"height":100}},"637a513e-3d40-11e5-8695-8185f7405bd4":{"id":"637a513e-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[43000,28000],"end":[43000,26000],"width":400,"height":100}},"637a513f-3d40-11e5-8695-8185f7405bd4":{"id":"637a513f-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[43000,26000],"end":[48000,26000],"width":400,"height":100}},"637a7840-3d40-11e5-8695-8185f7405bd4":{"id":"637a7840-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[48000,26000],"end":[48000,24000],"width":400,"height":100}},"637a7841-3d40-11e5-8695-8185f7405bd4":{"id":"637a7841-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[48000,24000],"end":[43000,24000],"width":400,"height":100}},"637a7842-3d40-11e5-8695-8185f7405bd4":{"id":"637a7842-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[43000,24000],"end":[43000,22000],"width":400,"height":100}},"637a7843-3d40-11e5-8695-8185f7405bd4":{"id":"637a7843-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[43000,22000],"end":[48000,22000],"width":400,"height":100}},"637a7844-3d40-11e5-8695-8185f7405bd4":{"id":"637a7844-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[48000,22000],"end":[48000,20000],"width":400,"height":100}},"637a7845-3d40-11e5-8695-8185f7405bd4":{"id":"637a7845-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[48000,20000],"end":[45000,20000],"width":400,"height":100}},"637a7846-3d40-11e5-8695-8185f7405bd4":{"id":"637a7846-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[45000,20000],"end":[45000,17000],"width":400,"height":100}},"637a7847-3d40-11e5-8695-8185f7405bd4":{"id":"637a7847-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[45000,17000],"end":[49000,17000],"width":400,"height":100}},"637a7848-3d40-11e5-8695-8185f7405bd4":{"id":"637a7848-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[50000,10000],"radius1":700,"height":100}},"637a7849-3d40-11e5-8695-8185f7405bd4":{"id":"637a7849-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[49000,17000],"radius1":700,"height":100}},"637a784a-3d40-11e5-8695-8185f7405bd4":{"id":"637a784a-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[50000,40000],"end":[50000,20000],"width":400,"height":100}},"637a784b-3d40-11e5-8695-8185f7405bd4":{"id":"637a784b-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[50000,20000],"end":[60000,10000],"width":400,"height":100}},"637a784c-3d40-11e5-8695-8185f7405bd4":{"id":"637a784c-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[60000,10000],"radius1":700,"height":100}},"637a784d-3d40-11e5-8695-8185f7405bd4":{"id":"637a784d-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[50000,38000],"end":[53000,38000],"width":400,"height":100}},"637a784e-3d40-11e5-8695-8185f7405bd4":{"id":"637a784e-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[53000,38000],"end":[53000,35000],"width":400,"height":100}},"637a784f-3d40-11e5-8695-8185f7405bd4":{"id":"637a784f-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[53000,35000],"end":[55000,30000],"width":400,"height":100}},"637a7850-3d40-11e5-8695-8185f7405bd4":{"id":"637a7850-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[55000,30000],"end":[60000,30000],"width":400,"height":100}},"637a7851-3d40-11e5-8695-8185f7405bd4":{"id":"637a7851-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[60000,30000],"end":[60000,28000],"width":400,"height":100}},"637a7852-3d40-11e5-8695-8185f7405bd4":{"id":"637a7852-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[60000,28000],"end":[55000,28000],"width":400,"height":100}},"637a7853-3d40-11e5-8695-8185f7405bd4":{"id":"637a7853-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[55000,28000],"end":[55000,25000],"width":400,"height":100}},"637a7854-3d40-11e5-8695-8185f7405bd4":{"id":"637a7854-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[55000,25000],"end":[62000,25000],"width":400,"height":100}},"637a7855-3d40-11e5-8695-8185f7405bd4":{"id":"637a7855-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[62000,25000],"radius1":700,"height":100}},"637a7856-3d40-11e5-8695-8185f7405bd4":{"id":"637a7856-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[15000,15000],"end":[15000,12000],"width":400,"height":100}},"637a9f50-3d40-11e5-8695-8185f7405bd4":{"id":"637a9f50-3d40-11e5-8695-8185f7405bd4","name":"New Via","type":"Via","params":{"position":[15000,12000],"radius1":800,"radius2":700,"height":1000}},"637a9f51-3d40-11e5-8695-8185f7405bd4":{"id":"637a9f51-3d40-11e5-8695-8185f7405bd4","name":"New Via","type":"Via","params":{"position":[26000,12000],"radius1":800,"radius2":700,"height":1000}},"637a9f52-3d40-11e5-8695-8185f7405bd4":{"id":"637a9f52-3d40-11e5-8695-8185f7405bd4","name":"New Via","type":"Via","params":{"position":[44000,12000],"radius1":800,"radius2":700,"height":1000}},"637a9f53-3d40-11e5-8695-8185f7405bd4":{"id":"637a9f53-3d40-11e5-8695-8185f7405bd4","name":"New Via","type":"Via","params":{"position":[55000,12000],"radius1":800,"radius2":700,"height":1000}},"637a9f54-3d40-11e5-8695-8185f7405bd4":{"id":"637a9f54-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[55000,12000],"end":[55000,15000],"width":400,"height":100}},"637a9f55-3d40-11e5-8695-8185f7405bd4":{"id":"637a9f55-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[26000,12000],"end":[30000,10000],"width":400,"height":100}},"637a9f56-3d40-11e5-8695-8185f7405bd4":{"id":"637a9f56-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[44000,12000],"end":[40000,10000],"width":400,"height":100}},"637a9f57-3d40-11e5-8695-8185f7405bd4":{"id":"637a9f57-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[40000,10000],"end":[38000,7000],"width":400,"height":100}},"637a9f58-3d40-11e5-8695-8185f7405bd4":{"id":"637a9f58-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[30000,10000],"end":[32000,7000],"width":400,"height":100}},"637a9f59-3d40-11e5-8695-8185f7405bd4":{"id":"637a9f59-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[32000,7000],"radius1":700,"height":100}},"637a9f5a-3d40-11e5-8695-8185f7405bd4":{"id":"637a9f5a-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[38000,7000],"radius1":700,"height":100}}}},{"name":"control","color":"red","params":{"z_offset":1200,"flip":true},"features":{"637a9f5b-3d40-11e5-8695-8185f7405bd4":{"id":"637a9f5b-3d40-11e5-8695-8185f7405bd4","name":"New CircleValve","type":"CircleValve","params":{"position":[20000,34000],"radius1":1400,"radius2":1200,"height":800}},"637a9f5c-3d40-11e5-8695-8185f7405bd4":{"id":"637a9f5c-3d40-11e5-8695-8185f7405bd4","name":"New CircleValve","type":"CircleValve","params":{"position":[30000,34000],"radius1":1400,"radius2":1200,"height":800}},"637a9f5d-3d40-11e5-8695-8185f7405bd4":{"id":"637a9f5d-3d40-11e5-8695-8185f7405bd4","name":"New CircleValve","type":"CircleValve","params":{"position":[40000,34000],"radius1":1400,"radius2":1200,"height":800}},"637a9f5e-3d40-11e5-8695-8185f7405bd4":{"id":"637a9f5e-3d40-11e5-8695-8185f7405bd4","name":"New CircleValve","type":"CircleValve","params":{"position":[50000,34000],"radius1":1400,"radius2":1200,"height":800}},"637ac660-3d40-11e5-8695-8185f7405bd4":{"id":"637ac660-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[20000,34000],"end":[24000,34000],"width":400,"height":100}},"637ac661-3d40-11e5-8695-8185f7405bd4":{"id":"637ac661-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[24000,34000],"end":[24000,47000],"width":400,"height":100}},"637ac662-3d40-11e5-8695-8185f7405bd4":{"id":"637ac662-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[30000,34000],"end":[34000,34000],"width":400,"height":100}},"637ac663-3d40-11e5-8695-8185f7405bd4":{"id":"637ac663-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[34000,34000],"end":[34000,47000],"width":400,"height":100}},"637ac664-3d40-11e5-8695-8185f7405bd4":{"id":"637ac664-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[40000,34000],"end":[37000,34000],"width":400,"height":100}},"637ac665-3d40-11e5-8695-8185f7405bd4":{"id":"637ac665-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[37000,34000],"end":[36000,34000],"width":400,"height":100}},"637ac666-3d40-11e5-8695-8185f7405bd4":{"id":"637ac666-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[36000,34000],"end":[36000,47000],"width":400,"height":100}},"637ac667-3d40-11e5-8695-8185f7405bd4":{"id":"637ac667-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[50000,34000],"end":[46000,34000],"width":400,"height":100}},"637ac668-3d40-11e5-8695-8185f7405bd4":{"id":"637ac668-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[46000,34000],"end":[46000,47000],"width":400,"height":100}},"637ac669-3d40-11e5-8695-8185f7405bd4":{"id":"637ac669-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[24000,47000],"radius1":700,"height":100}},"637ac66a-3d40-11e5-8695-8185f7405bd4":{"id":"637ac66a-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[34000,47000],"radius1":700,"height":100}},"637ac66b-3d40-11e5-8695-8185f7405bd4":{"id":"637ac66b-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[36000,47000],"radius1":700,"height":100}},"637ac66c-3d40-11e5-8695-8185f7405bd4":{"id":"637ac66c-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[46000,47000],"radius1":700,"height":100}},"637ac66d-3d40-11e5-8695-8185f7405bd4":{"id":"637ac66d-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[15000,12000],"end":[26000,12000],"width":400,"height":100}},"637ac66e-3d40-11e5-8695-8185f7405bd4":{"id":"637ac66e-3d40-11e5-8695-8185f7405bd4","name":"New Channel","type":"Channel","params":{"start":[44000,12000],"end":[55000,12000],"width":400,"height":100}},"637ac66f-3d40-11e5-8695-8185f7405bd4":{"id":"637ac66f-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[15000,12000],"radius1":700,"height":100}},"637ac670-3d40-11e5-8695-8185f7405bd4":{"id":"637ac670-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[26000,12000],"radius1":700,"height":100}},"637ac671-3d40-11e5-8695-8185f7405bd4":{"id":"637ac671-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[44000,12000],"radius1":700,"height":100}},"637ac672-3d40-11e5-8695-8185f7405bd4":{"id":"637ac672-3d40-11e5-8695-8185f7405bd4","name":"New Port","type":"Port","params":{"position":[55000,12000],"radius1":700,"height":100}}}}],"groups":[],"defaults":{}}');

var INTERLOCK_TOLERANCE = .125;
var HOLDER_BORDER_WIDTH = .41;
var SLIDE_Z_OFFSET = 1.20;
var HOLDER_SKIRT_WIDTH = .8;
var HOLDER_SKIRT_HEIGHT = .2;
var HOLDER_COLOR = [.5, .5, .5, 1];
var SLIDE_COLOR = [.75, .75, 1, .2];
var CORNER_DISTANCE = 10;
var SLIDE_THICKNESS = 1.20;
var COLORS = {
	"red": [.96, .26, .21],
	"indigo": [.25, .32, .71],
	"deep_purple": [.4, .23, .72]
};

function renderJSON(json) {
	sanitizeJSON(json);
	var dev = json.device;
	/*
	var features = json.features;
	var layers = json.layers;
	*/

	var options = [];
	var mockup = renderMockupNew(json);

	options.push(mockup);

	for (var layerID in json.layers) {
		options.push(renderLayerNew(json, layerID));
	}
	return options;
}

function sanitizeJSON(json) {
	sanitizeParams(json.params);
	for (var i = 0; i < json.layers.length; i++) {
		sanitizeParams(json.layers[i].params, json.params.height);
		for (var key in json.layers[i].features) {
			sanitizeParams(json.layers[i].features[key].params, json.params.height);
		}
	}
}

function renderLayerNew(json, layerIndex) {
	console.log("Rendering layer: " + layerIndex);
	var width = json.params.width;
	var height = json.params.height;
	var layer = json.layers[layerIndex];
	var renderedLayer = renderFeaturesNew(layer, 0);
	if (layer.params.flip) {
		renderedLayer = flipLayerNew(renderedLayer, width, height);
	}
	renderedLayer = renderedLayer.union(SlideHolder(width, height, SLIDE_THICKNESS, false));

	var package = {
		name: json.name + "_layer_" + layer.name,
		caption: layer.name + "(Printable Layer)",
		data: renderedLayer
	}
	console.log("...done");
	return package;
}

function renderMockupNew(json) {
	console.log("Rendering mockup");
	var layers = json.layers;
	var mockup = Placeholder();
	for (var i = 0; i < layers.length; i++) {
		layer = layers[i];
		mockup = mockup.union(renderFeaturesNew(layer, layer.params.z_offset));
	}
	var holder = SlideHolder(json.params.width, json.params.height, SLIDE_THICKNESS, true);
	mockup = mockup.union(holder);

	var package = {
		name: json.name + "_mockup",
		caption: "Full Mockup (All Layers)",
		data: mockup
	};
	console.log("...done");
	return package;
}

function flipLayerNew(layer, width) {
	var rotated = layer.rotateY(180);
	var translated = rotated.translate([width, 0, 0]);
	return translated;
}

function renderFeaturesNew(layer, z_offset) {
	var renderedFeatures = Placeholder();
	var color;
	if (layer.color) {
		color = layer.color;
	} else color = "red";
	for (var featureID in layer.features) {
		var feature = layer.features[featureID];
		renderedFeatures = renderedFeatures.union(renderFeatureNew(feature, layer.params.flip, z_offset, color));
	}
	return renderedFeatures;
}

function renderFeatureNew(feature, flip, z_offset, color) {
	//console.log(featureData);
	var type = feature.type;
	var params = feature.params;
	var renderedFeature;

	if (type == "Channel") {
		renderedFeature = Channel(params.start, params.end, params.width, params.height, flip, z_offset);
	} else if (type == "CircleValve") {
		renderedFeature = Valve(params.position, params.radius1, params.radius2, params.height, flip, z_offset);
	} else if (type == "Standoff") {
		renderedFeature = Standoff(params.position, params.radius1, params.radius2, params.height, flip, z_offset);
	} else if (type == "Port") {
		renderedFeature = Port(params.position, params.radius1, params.height, flip, z_offset);
	} else if (type == "Via") {
		renderedFeature = Via(params.position, params.radius1, params.radius2, params.height, flip, z_offset);
	} else {
		//console.log(type);
	}

	renderedFeature = renderedFeature.setColor(COLORS[color]);
	return renderedFeature;
}

function sanitizeParams(params, height) {
	for (var key in params) {
		if (key == "start" || key == "end" || key == "position") {
			console.log("Sanitizing point: " + params[key]);
			var pos = params[key];
			params[key] = [pos[0] / 1000, height - (pos[1] / 1000)];
			console.log("Sanitized: " + params[key]);
		} else {
			console.log("Sanitizing value: " + params[key]);
			params[key] = params[key] / 1000;
			console.log("Sanitized: " + params[key]);
		}
	}
}

function main(params) {
	var target;

	return renderJSON(device_json);
}

function Slide(width, height, thickness) {
	var slide = CSG.cube({
		radius: [width / 2, height / 2, thickness / 2]
	});
	slide = slide.translate([width / 2, height / 2, thickness / 2]);
	slide = slide.translate([0, 0, -thickness - .00001]);
	slide = slide.setColor(SLIDE_COLOR);
	return slide;
}

function SlideHolder(width, height, thickness, slide) {

	var innerX = width + INTERLOCK_TOLERANCE * 2;
	var innerY = height + INTERLOCK_TOLERANCE * 2;
	var innerZ = thickness + INTERLOCK_TOLERANCE;

	var outerX = innerX + HOLDER_BORDER_WIDTH * 2;
	var outerY = innerY + HOLDER_BORDER_WIDTH * 2;
	var outerZ = thickness;

	var vertX = innerX - CORNER_DISTANCE * 2;
	var vertY = outerY;
	var vertZ = innerZ;

	var horX = outerX;
	var horY = innerY - CORNER_DISTANCE * 2;
	var horZ = innerZ;

	var skirtX = outerX + HOLDER_SKIRT_WIDTH * 2;
	var skirtY = outerY + HOLDER_SKIRT_WIDTH * 2;
	var skirtZ = HOLDER_SKIRT_HEIGHT;

	var inner = CSG.cube({
		radius: [innerX / 2, innerY / 2, innerZ / 2]
	});

	var outer = CSG.cube({
		radius: [outerX / 2, outerY / 2, outerZ / 2]
	});

	var vert = CSG.cube({
		radius: [vertX / 2, vertY / 2, vertZ / 2]
	});

	var hor = CSG.cube({
		radius: [horX / 2, horY / 2, horZ / 2]
	});

	var skirt = CSG.cube({
		radius: [skirtX / 2, skirtY / 2, skirtZ / 2]
	});

	skirt = skirt.translate([0, 0, -outerZ / 2 + skirtZ / 2]);

	var blank = outer.union(skirt);
	var border = blank.subtract([inner, vert, hor]);

	//var border = outer.subtract([inner, vert, hor]);
	border = border.translate([outerX / 2, outerY / 2, outerZ / 2]);
	border = border.setColor(HOLDER_COLOR);
	border = border.translate([-INTERLOCK_TOLERANCE - HOLDER_BORDER_WIDTH, -INTERLOCK_TOLERANCE - HOLDER_BORDER_WIDTH, -thickness]);

	if (slide) {
		border = border.union(Slide(width, height, thickness));
	}

	return border;
}

function Channel(start, end, width, height, flip, z_offset) {
	return TwoPointBox(start, end, width, height, flip, z_offset);
}

function Valve(position, radius1, radius2, height, flip, z_offset) {
	return Cylinder(position, radius1, radius2, height, flip, z_offset);
}

function Standoff(position, radius1, radius2, height, flip, z_offset) {
	return Cylinder(position, radius1, radius2, height, flip, z_offset);
}

function Port(position, radius, height, flip, z_offset) {
	return Cylinder(position, radius, radius, height, flip, z_offset);
}

function Via(position, radius1, radius2, height, flip, z_offset) {
	return Cylinder(position, radius1, radius2, height, flip, z_offset);
}

function Cylinder(position, radius1, radius2, height, flip, z_offset) {
	var bottom = [0, 0, 0];
	var top = [0, 0, height];
	var cyl = CSG.cylinder({
		start: bottom,
		end: top,
		radiusStart: radius1,
		radiusEnd: radius2
	});
	if (flip) {
		cyl = cyl.rotateX(180);
	}
	cyl = cyl.translate([position[0], position[1], z_offset]);
	return cyl;
}

function TwoPointBox(start, end, width, height, flip, z_offset) {
	var dX = end[0] - start[0];
	var dY = end[1] - start[1];
	var angle_deg = Math.atan2(dY, dX) * (180 / Math.PI);
	var dXPow = Math.pow(dX, 2);
	var dYPow = Math.pow(dY, 2);
	var length = Math.sqrt(dXPow + dYPow);
	var center = []
	var rect = CSG.cube({
		radius: [length / 2, width / 2, height / 2]
	});
	rect = rect.rotateZ(angle_deg);
	rect = rect.translate([dX / 2, dY / 2, height / 2]);
	rect = rect.translate([start[0], start[1], z_offset]);
	var startCircle = CSG.cylinder({
		start: [start[0], start[1], z_offset],
		end: [start[0], start[1], z_offset + height],
		radius: width / 2,
	})

	var endCircle = CSG.cylinder({
		start: [end[0], end[1], z_offset],
		end: [end[0], end[1], z_offset + height],
		radius: width / 2,
	})

	var whole = rect.union([startCircle, endCircle]);

	if (flip) {
		whole = whole.translate([0, 0, -height]);
	}

	return whole;
}

function Placeholder() {
	return CSG.cube({
		radius: [0, 0, 0]
	})
}

function getParameterDefinitions() {
	return [{
			name: "slideWidth",
			type: "float",
			initial: 75.8
		}, {
			name: "slideHeight",
			type: "float",
			initial: 51
		}, {
			name: "slideThickness",
			type: "float",
			initial: 1.20
		}];
}